<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Document</title>
  <link rel="stylesheet" href="node_modules\bootstrap\dist\css\bootstrap.min.css">
  <link rel="stylesheet" href="mechounter.css">
  <script type="text/javascript" src="jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="jquery.mechounter.develop.js"></script>
</head>
<body>
  <button id="switch" class="btn btn-default btn-xs">Переключиться</button>
  <div id="develop">
    <style>
      #dbgDiv {
        display: inline-block;
        border: solid 1px darkred;
        padding: 3px;
      }
      #graph {
        position:absolute;
        width: 400px;
        height: 400px;
        top: 5px;
        left: 200px;
        z-index: -1;
        background: #fde;
      }
      #list {
        position: absolute;
        width: 300px;
        top: 5px;
        left: 650px;
        background: #efd;
        border: solid 1px #dfb;
        border-radius: 5px;
        padding: 0 6px;
      }
      #list > div {
        border: solid 1px #dfb;
        border-radius: 3px;
        margin: 4px 0;
        padding: 2px 6px;
        cursor: pointer;
      }
      button{
        cursor: pointer;
      }
    </style>

    <div id="dbgDiv">
      <b>Debug</b><br>
      Mode: <span id="dbgMode"></span> <button id="btnMode">switch</button><br>
      Step: <button id="btnPrev"> prev</button>
      <button id="btnNext"> next</button>
    </div>
    <br>
    <span id="someValue" class="bg-success">234.00</span>
    <br>
    <span id="debug"></span>
    <br>
    <span id="debug2"></span>

    <br><input id="difVal" type="number" min="0" max="100000000" value="175905" placeholder="Новое значение" title="Новое значение" style="width: 170px"/>
    <br><input id="time" type="number" min="0" max="20000" value="5000" placeholder="Интервал в меллисекундах" title="Интервал в меллисекундах" style="width: 170px"/>
    <br><button id="btnGo">go!</button>
    <div id='graph'></div>
    <div id='list'></div>
  </div>
  <div id="examine" hidden class="container">
    <div class="row page-header">

      <div class="col-sm-6 col-md-8 col-lg-9">

        <button id="addCntr" class="btn btn-default" title="Добавить счетчик"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Добавить</button>

        &nbsp;&nbsp;

        <div class="btn-group" role="group" aria-label="...">
          <a class="app-btn-add__001 btn btn-default" href="#" role="button">+0.01</a>
          <a class="app-btn-add__01_ btn btn-default" href="#" role="button">+0.1</a>
          <a class="app-btn-add__1__ btn btn-default" href="#" role="button">+1</a>
          <a class="app-btn-add_10__ btn btn-default" href="#" role="button">+10</a>
        </div>

        <button type="button" class="app-btn-go btn btn-primary"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Пуск!</button>

      </div>

      <div class="col-sm-6 col-md-4 col-lg-3">

        <div class="input-group has-error">
          <span class="input-group-btn">
            <button type="button" class="app-btn-reset btn btn-danger"><span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Сбросить до</button>
          </span>
          <input class="app-inp-reset form-control" type="number" min="0" max="100000000" value="175" placeholder="Значение сброса" title="Значение сброса"/>
          <div class="input-group-addon">ед</div>
        </div><!-- /input-group -->

      </div>

    </div>

    <div id="cntrs" class="row">

    </div>

    <template id="cntrBlock" class="hidden">
      <div class="col-xs-6 col-sm-4 col-md-3 col-lg-2">

        <div class="panel panel-default">

          <div class="panel-heading clearfix">
            <button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="panel-body">

            <div class="text-center bg-success">

              <span class="counter">123.55</span>

            </div>

          </div>

          <div class="btn-group btn-group-justified" role="group" aria-label="...">
            <a class="app-btn-add__001 btn btn-default btn-xs" href="#" role="button">+0.01</a>
            <a class="app-btn-add__01_ btn btn-default btn-xs" href="#" role="button">+0.1</a>
            <a class="app-btn-add__1__ btn btn-default btn-xs" href="#" role="button">+1</a>
            <a class="app-btn-add_10__ btn btn-default btn-xs" href="#" role="button">+10</a>
          </div>

          <div class="input-group">
            <input class="app-inp-value form-control input-sm" type="number" min="0" max="100000000" value="2016" placeholder="Новое значение" title="Новое значение"/>
            <div class="input-group-addon">ед</div>
          </div>
          <div class="input-group">
            <input class="app-inp-delay form-control input-sm" type="number" min="0" max="20000" value="5000" placeholder="Интервал в меллисекундах" title="Интервал в меллисекундах"/>
            <div class="input-group-addon">мс</div>
          </div>

          <button type="button" class="app-btn-go btn btn-primary btn-block"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Пуск!</button>
          <div class="app-btn-reset hidden"></div>

        </div>

      </div>
    </template>
  </div>
  <div class="hidden">
    <script>
$(function(){

  //common code
  ;(function(){
    var isDevelopShown = true;

    function togglePages(){
      $("#develop").toggle(isDevelopShown);
      $("#examine").toggle(!isDevelopShown);
    }
    togglePages();

    $("#switch").click(function(){
      isDevelopShown = !isDevelopShown;
      togglePages();
    });
  })();

  //development block
  ;(function (){

    var dt, dv, v0, lx;
    $g = $("#graph");

    var initialValue = 132.999;
    var initialDebug = true;

    var cntr = window.cntr = new MechanicalCounter($("#someValue"), {
      mask: "`7,2",
      value: initialValue,
      onBeforeSpin: function(dt_, dv_, v0_){
        lx = -10;
        dt = dt_;
        dv = dv_;
        v0 = v0_;
        $g.html("");
        //$("#debug2").text("dt:"+dt + ", dv:" +dv+", v0:"+v0);
      },
      onSpinStep: function(t, v){
        var x = t/dt * 400;
        if(x == lx) return;
        lx = x;

        var y = 400 - (v-v0)/dv * 400;
        $g.append("<div style='position: absolute; top: " + y + "px; left: " + x + "px; width: 1px; height: 1px; background: red'/>");
        //$("#debug").text("t:"+t + ", v:" +v+", x:"+x+", y: "+y);
      }
    });
    cntr._dbgMode = initialDebug;
    $("#dbgMode").text(cntr._dbgMode ? "on" : "off");

    function next(){
      if(cntr._dbgStep && cntr._dbgMode) cntr._dbgStep();
    }
    $("#btnNext").click(next);

    function prev(){
      if(cntr._dbgStep && cntr._dbgMode) cntr._dbgStep(true);
    }
    $("#btnPrev").click(prev);

    $(document).keydown(function(e){
      switch(e.keyCode) {
        case 37:                //left
        case 38: return prev(); //up
        case 39:                //right
        case 40: return next(); //down
      }
    });

    $("#btnMode").click(function(){
      cntr._dbgMode = !cntr._dbgMode;
      $("#dbgMode").text(cntr._dbgMode ? "on" : "off");
    });

    function createBtnDiv(value, time){
      function run(){
        cntr.setValue(value, time);
      };

      $("<div>").text("Знач: "+value+", время(мс): "+time).appendTo("#list").click(run);
      return run;
    }

    createBtnDiv(200, 100);
    createBtnDiv(200, 7000);
    createBtnDiv(132.999, 20000);
    createBtnDiv(132.999, 7000);
    createBtnDiv(132.999, 4000);
    createBtnDiv(152.999, 2000);
    createBtnDiv(1500022.999, 20000);
    createBtnDiv(1500022.999, 2000);
    createBtnDiv(1503089.555, 5000);
    createBtnDiv(1506067.777, 5000);

    $("#btnGo").click(function(){
      createBtnDiv(+$("#difVal").val(), +$("#time").val())();
    });

    function deltaByKeyCode(code){
      switch(code) {
        case 37: return -0.01;
        case 38: return -0.10;
        case 39: return +0.01;
        case 40: return +0.10;
      }
      return 0;
    }

  })();

  //examine block
  ;(function(){

    var allCntrs = window.allCntrs = [];
    var resetValue;

    function addCntr(){

      var cntr, value = 2016, delay = 5000;

      var $cntrBlock = $($("#cntrBlock").html()).prependTo("#cntrs").hide().fadeIn(1000, function(){
        cntr = new MechanicalCounter($cntrBlock.find(".counter"), {
          mask: "`7,2",
          value: 345.89
        });

        allCntrs.push(cntr);

      });

      $cntrBlock.find(".close").click(function(){
        $(this).off("click").click(destroy);
        $cntrBlock.stop(true).fadeOut(1000, destroy);

        function destroy(){
          allCntrs.splice(allCntrs.indexOf(cntr), 1);
          $cntrBlock.remove();
        }

      });

      $cntrBlock.find(".app-btn-add__001").click(function(){
        cntr.setValue(cntr.getValue() + 0.01, delay);
      });

      $cntrBlock.find(".app-btn-add__01_").click(function(){
        cntr.setValue(cntr.getValue() + 0.1, delay);
      });

      $cntrBlock.find(".app-btn-add__1__").click(function(){
        cntr.setValue(cntr.getValue() + 1, delay);
      });

      $cntrBlock.find(".app-btn-add_10__").click(function(){
        cntr.setValue(cntr.getValue() + 10, delay);
      });

      $cntrBlock.find(".app-btn-go").click(function(){
        //value = $cntrBlock.find(".app-inp-value").val();
        //delay = $cntrBlock.find(".app-inp-delay").val();
        cntr.setValue(value, delay);
      });

      $cntrBlock.find(".app-inp-value").change(function(){
        value = $(this).val();
      })

      $cntrBlock.find(".app-inp-delay").change(function(){
        delay = $(this).val();
      })

      $cntrBlock.find(".app-btn-reset").click(function(){
        cntr.resetValue(resetValue);
      });

    }

    var i = 1;
    while(i--){
      addCntr();
    }

    $("#addCntr").click(addCntr);

    $(".page-header .app-btn-add__001").click(function(){
      $("#cntrs .app-btn-add__001").click();
    });

    $(".page-header .app-btn-add__001").click(function(){
      $("#cntrs .app-btn-add__001").click();
    });

    $(".page-header .app-btn-add__1__").click(function(){
      $("#cntrs .app-btn-add__1__").click();
    });

    $(".page-header .app-btn-add_10__").click(function(){
      $("#cntrs .app-btn-add_10__").click();
    });

    $(".page-header .app-btn-go").click(function(){
      $("#cntrs .app-btn-go").click();
    });

    $(".page-header .app-btn-reset").click(function(){
      resetValue = $(".page-header .app-inp-reset").val();
      $("#cntrs .app-btn-reset").click();
    });

  })();

});
    </script>
  </div>

  </body>
</html>
